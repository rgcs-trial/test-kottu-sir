# Stripe Payment Integration - Production Ready\n\nThis is a comprehensive Stripe payment integration for the restaurant ordering platform, built with security, scalability, and production readiness in mind.\n\n## 🚀 Features\n\n### Core Payment Processing\n- **Multi-party payments** with 3% platform fee\n- **Stripe Connect** integration for restaurant accounts\n- **Payment intents** with confirmation workflow\n- **Guest checkout** and authenticated user payments\n- **Saved payment methods** for returning customers\n- **Digital wallets** (Apple Pay, Google Pay)\n- **3D Secure** authentication support\n\n### Security & Compliance\n- **PCI DSS compliant** architecture\n- **Input sanitization** and validation\n- **Rate limiting** on all payment endpoints\n- **Webhook signature** verification\n- **Suspicious payment** detection\n- **Security event** logging and monitoring\n- **Environment-based** key validation\n\n### Error Handling & Monitoring\n- **Comprehensive error** classification\n- **Automatic retry** with exponential backoff\n- **Structured logging** for debugging\n- **Health checks** for system monitoring\n- **Production readiness** validation\n\n### Developer Experience\n- **TypeScript** throughout\n- **React hooks** for easy integration\n- **Reusable components** for UI\n- **Comprehensive testing** suite\n- **Production deployment** guides\n\n## 📁 File Structure\n\n```\nrestaurant-saas/\n├── app/api/stripe/\n│   ├── connect/\n│   │   ├── onboard/route.ts          # Restaurant onboarding\n│   │   └── status/route.ts           # Account status check\n│   ├── create-payment-intent/route.ts # Payment intent creation\n│   ├── confirm-payment/route.ts       # Payment confirmation\n│   └── webhook/route.ts               # Webhook handler\n├── components/\n│   ├── payment/\n│   │   ├── stripe-payment-form.tsx   # Main payment form\n│   │   ├── payment-methods.tsx       # Saved payment methods\n│   │   └── saved-cards.tsx           # Card management\n│   └── restaurant/\n│       └── stripe-onboarding.tsx     # Restaurant setup\n├── hooks/\n│   ├── use-stripe.tsx                # Stripe client hooks\n│   └── use-payment.tsx               # Payment processing hooks\n├── lib/\n│   ├── stripe/\n│   │   ├── server.ts                 # Server-side Stripe utilities\n│   │   ├── client.ts                 # Client-side utilities\n│   │   └── connect.ts                # Connect account management\n│   ├── payments/\n│   │   └── actions.ts                # Payment processing actions\n│   ├── security/\n│   │   └── validation.ts             # Security & validation utilities\n│   ├── monitoring/\n│   │   └── error-handler.ts          # Error handling & monitoring\n│   └── testing/\n│       └── stripe-integration-tests.ts # Comprehensive test suite\n└── components/ui/\n    ├── alert.tsx                     # Alert component\n    ├── dialog.tsx                    # Dialog component\n    └── progress.tsx                  # Progress component\n```\n\n## ⚙️ Environment Configuration\n\n### Required Environment Variables\n\n```bash\n# Stripe Keys (Use test keys for development)\nSTRIPE_SECRET_KEY=sk_test_... or sk_live_...\nNEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_... or pk_live_...\nSTRIPE_WEBHOOK_SECRET=whsec_...\n\n# Database (if using custom tables)\nDATABASE_URL=your_database_url\n\n# Next.js\nNEXT_PUBLIC_APP_URL=http://localhost:3000\nNODE_ENV=development|staging|production\n```\n\n### Stripe Dashboard Setup\n\n1. **Create Stripe Account**\n   - Sign up at https://stripe.com\n   - Complete business verification for live mode\n\n2. **Enable Stripe Connect**\n   - Go to Connect settings in Dashboard\n   - Enable Express accounts for restaurants\n   - Configure platform settings\n\n3. **Configure Webhooks**\n   - Add endpoint: `https://yourdomain.com/api/stripe/webhook`\n   - Enable events:\n     - `payment_intent.succeeded`\n     - `payment_intent.payment_failed`\n     - `payment_intent.requires_action`\n     - `account.updated`\n     - `capability.updated`\n     - `transfer.paid`\n     - `payout.paid`\n     - `charge.dispute.created`\n\n4. **Platform Fee Setup**\n   - Current configuration: 3% platform fee\n   - Modify `PLATFORM_FEE_PERCENTAGE` in `/lib/stripe/server.ts`\n\n## 🔧 Installation & Setup\n\n### 1. Install Dependencies\n\n```bash\nnpm install @stripe/stripe-js stripe\n```\n\n### 2. Add UI Components\n\nThe integration includes custom UI components. Ensure you have:\n\n```bash\nnpm install @radix-ui/react-dialog @radix-ui/react-progress\nnpm install lucide-react class-variance-authority\nnpm install zod react-hook-form\n```\n\n### 3. Database Schema\n\nAdd Stripe-related fields to your existing tables:\n\n```sql\n-- Add to restaurants table\nALTER TABLE restaurants ADD COLUMN stripe_connect_account_id VARCHAR(255);\nALTER TABLE restaurants ADD COLUMN stripe_account_status JSONB;\n\n-- Add to orders table  \nALTER TABLE orders ADD COLUMN payment_intent_id VARCHAR(255);\nALTER TABLE orders ADD COLUMN platform_fee DECIMAL(10,2);\n\n-- Add to users table (optional)\nALTER TABLE users ADD COLUMN stripe_customer_id VARCHAR(255);\n```\n\n### 4. Test the Integration\n\n```bash\n# Run the comprehensive test suite\nnpm run test:stripe\n\n# Or test manually\nnode -e \"\nconst { runStripeIntegrationTests } = require('./lib/testing/stripe-integration-tests.ts');\nrunStripeIntegrationTests().then(console.log);\n\"\n```\n\n## 🛡️ Security Features\n\n### Input Validation & Sanitization\n\n```typescript\nimport { SecurePaymentDataSchema } from '@/lib/security/validation'\n\n// All payment data is validated and sanitized\nconst validatedData = SecurePaymentDataSchema.parse(requestData)\n```\n\n### Rate Limiting\n\n- **Payment Creation**: 100 requests per 15 minutes\n- **Payment Confirmation**: 20 requests per 5 minutes  \n- **Webhook Processing**: 1000 requests per minute\n- **Restaurant Onboarding**: 10 requests per hour\n\n### Suspicious Activity Detection\n\n```typescript\nconst { isSuspicious, reasons } = detectSuspiciousPayment({\n  amount: 50000, // Large amount\n  customerEmail: 'test@10minutemail.com', // Disposable email\n  customerName: 'test user', // Suspicious name\n});\n// Result: { isSuspicious: true, reasons: [...] }\n```\n\n### Webhook Security\n\n- Signature verification required\n- Timestamp validation (5-minute tolerance)\n- Source validation (Stripe User-Agent)\n- Replay attack prevention\n\n## 🎯 Usage Examples\n\n### 1. Restaurant Onboarding\n\n```typescript\nimport { StripeOnboarding } from '@/components/restaurant/stripe-onboarding'\n\nfunction RestaurantSetup() {\n  return (\n    <StripeOnboarding\n      restaurantId=\"rest_123\"\n      restaurantName=\"Pizza Palace\"\n      restaurantEmail=\"owner@pizzapalace.com\"\n    />\n  )\n}\n```\n\n### 2. Payment Processing\n\n```typescript\nimport { PaymentForm } from '@/components/payment/stripe-payment-form'\n\nfunction Checkout() {\n  const handlePaymentSuccess = (result) => {\n    console.log('Payment successful:', result.paymentIntentId)\n    // Redirect to success page\n  }\n  \n  const handlePaymentError = (error) => {\n    console.error('Payment failed:', error)\n    // Show error message\n  }\n  \n  return (\n    <PaymentForm\n      paymentData={{\n        amount: 25.50,\n        restaurantId: \"rest_123\",\n        customerEmail: \"customer@example.com\",\n        customerName: \"John Doe\",\n        items: [\n          { id: \"item1\", name: \"Pizza\", price: 20.00, quantity: 1 },\n          { id: \"item2\", name: \"Drink\", price: 5.50, quantity: 1 }\n        ]\n      }}\n      onPaymentSuccess={handlePaymentSuccess}\n      onPaymentError={handlePaymentError}\n    />\n  )\n}\n```\n\n### 3. Saved Payment Methods\n\n```typescript\nimport { SavedCards } from '@/components/payment/saved-cards'\n\nfunction PaymentSettings({ customerId }) {\n  return (\n    <SavedCards customerId={customerId} />\n  )\n}\n```\n\n### 4. Using Payment Hooks\n\n```typescript\nimport { usePayment } from '@/hooks/use-payment'\nimport { useConnectAccount } from '@/hooks/use-stripe'\n\nfunction PaymentComponent() {\n  const { isProcessing, error, processPayment } = usePayment()\n  const { account, isLoading } = useConnectAccount(restaurantId)\n  \n  const handlePayment = async () => {\n    const result = await processPayment({\n      amount: 10.00,\n      restaurantId: \"rest_123\",\n      customerEmail: \"test@example.com\",\n      customerName: \"Test User\"\n    })\n    \n    if (result.success) {\n      console.log('Payment successful!')\n    }\n  }\n  \n  return (\n    <button onClick={handlePayment} disabled={isProcessing}>\n      {isProcessing ? 'Processing...' : 'Pay Now'}\n    </button>\n  )\n}\n```\n\n## 🔄 Payment Flow\n\n### Customer Payment Flow\n\n1. **Customer** adds items to cart\n2. **Frontend** calls `/api/stripe/create-payment-intent`\n3. **Backend** creates PaymentIntent with platform fee\n4. **Frontend** collects payment method with Stripe Elements\n5. **Frontend** confirms payment with `/api/stripe/confirm-payment`\n6. **Stripe** processes payment and sends webhooks\n7. **Backend** updates order status via webhook\n8. **Customer** receives confirmation\n\n### Restaurant Onboarding Flow\n\n1. **Restaurant owner** clicks \"Setup Payments\"\n2. **Frontend** calls `/api/stripe/connect/onboard`\n3. **Backend** creates Connect account and onboarding link\n4. **Restaurant owner** completes Stripe onboarding\n5. **Stripe** redirects back with account status\n6. **Backend** updates restaurant account capabilities\n7. **Restaurant** can accept payments\n\n## 📊 Monitoring & Analytics\n\n### Error Monitoring\n\n```typescript\nimport { paymentErrorLogger } from '@/lib/monitoring/error-handler'\n\n// Errors are automatically logged with context\nconst error = paymentErrorLogger.logError(new Error('Payment failed'), {\n  operation: 'payment_processing',\n  userId: 'user_123',\n  paymentIntentId: 'pi_123'\n})\n\n// Get error statistics\nconst stats = paymentErrorLogger.getErrorStats()\nconsole.log(`${stats.total} errors in last hour`)\n```\n\n### Health Checks\n\n```typescript\nimport { checkPaymentSystemHealth } from '@/lib/monitoring/error-handler'\n\nconst health = await checkPaymentSystemHealth()\nif (!health.healthy) {\n  console.error('System unhealthy:', health.errors)\n}\n```\n\n### Production Readiness\n\n```typescript\nimport { runProductionReadinessCheck } from '@/lib/testing/stripe-integration-tests'\n\nconst check = await runProductionReadinessCheck()\nif (check.ready) {\n  console.log('✅ Ready for production!')\n} else {\n  console.log('❌ Issues:', check.issues)\n}\n```\n\n## 🚀 Deployment\n\n### Pre-deployment Checklist\n\n- [ ] All environment variables configured\n- [ ] Live Stripe keys for production\n- [ ] Webhook endpoints configured\n- [ ] Database schema updated\n- [ ] Integration tests passing\n- [ ] Security audit completed\n- [ ] Error monitoring configured\n\n### Production Configuration\n\n```bash\n# Use live Stripe keys\nSTRIPE_SECRET_KEY=sk_live_...\nNEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_live_...\nSTRIPE_WEBHOOK_SECRET=whsec_...\n\n# Production settings\nNODE_ENV=production\nNEXT_PUBLIC_APP_URL=https://yourdomain.com\n```\n\n### Monitoring Setup\n\nIntegrate with your monitoring service:\n\n```typescript\n// In production, send errors to your monitoring service\nconst logger = PaymentErrorLogger.getInstance()\nlogger.on('error', (error) => {\n  // Send to Sentry, DataDog, etc.\n  monitoringService.captureError(error)\n})\n```\n\n## 🧪 Testing\n\n### Test Cards (Stripe Test Mode)\n\n```typescript\n// Successful payment\ncard: '4242424242424242'\n\n// Declined payment  \ncard: '4000000000000002'\n\n// Requires authentication (3D Secure)\ncard: '4000002760003184'\n\n// Insufficient funds\ncard: '4000000000009995'\n```\n\n### Running Tests\n\n```bash\n# Run integration tests\nnode -e \"require('./lib/testing/stripe-integration-tests.ts').runStripeIntegrationTests().then(console.log)\"\n\n# Run production readiness check\nnode -e \"require('./lib/testing/stripe-integration-tests.ts').runProductionReadinessCheck().then(console.log)\"\n```\n\n## 🛠️ Customization\n\n### Platform Fee Adjustment\n\n```typescript\n// In /lib/stripe/server.ts\nconst PLATFORM_FEE_PERCENTAGE = 0.05 // 5% instead of 3%\n```\n\n### Adding Payment Methods\n\n```typescript\n// In payment form options\nPaymentElement({\n  options: {\n    paymentMethodOrder: ['card', 'apple_pay', 'google_pay', 'klarna']\n  }\n})\n```\n\n### Custom Styling\n\n```typescript\n// In Stripe Elements appearance\nappearance: {\n  theme: 'stripe',\n  variables: {\n    colorPrimary: '#your-brand-color',\n    colorBackground: '#ffffff',\n    fontFamily: 'Your Font, sans-serif'\n  }\n}\n```\n\n## 📞 Support\n\n### Common Issues\n\n1. **\"No such account\" errors**\n   - Ensure Connect account is fully onboarded\n   - Check account ID format\n\n2. **Webhook signature verification failed**\n   - Verify webhook secret is correct\n   - Check timestamp tolerance\n\n3. **Rate limit exceeded**\n   - Implement proper retry logic\n   - Consider increasing limits for high-volume restaurants\n\n### Debug Mode\n\n```typescript\n// Enable debug logging\nprocess.env.DEBUG = 'stripe:*'\n\n// Check system health\nconst health = await checkPaymentSystemHealth()\nconsole.log(health)\n```\n\n### Resources\n\n- [Stripe Documentation](https://stripe.com/docs)\n- [Stripe Connect Guide](https://stripe.com/docs/connect)\n- [Stripe Elements](https://stripe.com/docs/stripe-js)\n- [Webhook Testing](https://stripe.com/docs/webhooks/test)\n\n---\n\n**This integration is production-ready and includes comprehensive security, error handling, monitoring, and testing capabilities. It follows Stripe's best practices and is designed for scalable restaurant ordering platforms.**\n\n*Platform fee: 3% | Stripe fee: 2.9% + $0.30 | Total processing cost: ~5.9% + $0.30*